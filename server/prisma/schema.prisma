generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                      String            @id @default(uuid())
  clerkId                 String            @unique
  email                   String            @unique
  firstName               String?
  lastName                String?
  avatarUrl               String?
  gpa                     Float?
  satScore                Int?
  actScore                Int?
  preferredMajor          String?
  dreamJobTitle           String?
  careerGoals             String[]
  preferredLearningStyle  String?
  personalityType         String?
  hobbies                 String[]
  languagesSpoken         String[]
  role                    UserRole          @default(USER)
  createdAt               DateTime          @default(now())
  updatedAt               DateTime          @updatedAt
  referralCode            String?           @unique
  referredBy              String?
  accountType             String?
  focusArea               String?
  onboarded               Boolean           @default(false)
  onboardingAnswers       Json?
  organizationName        String?
  personaRole             String?
  primaryGoal             String?
  onboardingSkipped       Boolean           @default(false)
  profileSettings         Json?
  profileVisibility       ProfileVisibility @default(PRIVATE)
  username                String?           @unique
  academicProfile         AcademicProfile?
  analysisWeights         AnalysisWeights?
  articles                Article[]            @relation("ArticleAuthor")
  reviewedArticles        Article[]            @relation("ArticleReviewer")
  articleLikes            ArticleLike[]
  ClaimMessage            ClaimMessage[]
  comments                Comment[]
  reviewedDocuments       DocumentApproval[]   @relation("DocumentReviewer")
  comparisons             Comparison[]
  financialProfile        FinancialProfile?
  notifications           Notification[]
  referralsReceived       Referral?         @relation("Referred")
  referralsGiven          Referral[]        @relation("Referrer")
  reviews                 Review[]
  savedUniversities       SavedUniversity[]
  savedArticles           SavedArticle[]
  claimedUniversities     University[]      @relation("UniversityClaim")
  reviewedClaims          UniversityClaim[] @relation("ClaimReviewer")
  universityClaims        UniversityClaim[]
  claimedUniversityGroups UniversityGroup[] @relation("UniversityGroupClaim")
  referrer                User?             @relation("UserReferrals", fields: [referredBy], references: [id])
  referrals               User[]            @relation("UserReferrals")
  badges                  UserBadge[]

  @@index([clerkId])
  @@index([username])
}

model University {
  id                       String                     @id @default(uuid())
  slug                     String                     @unique
  name                     String
  shortName                String?
  description              String?
  logoUrl                  String?
  logoMediaId              String?                    // NEW: Canonical reference to Media Library
  heroImageUrl             String?
  heroImageMediaId         String?                    // NEW: Canonical reference to Media Library
  websiteUrl               String?
  established              Int?
  address                  String?
  city                     String
  state                    String?
  zipCode                  String?
  country                  String                     @default("USA")
  latitude                 Float?
  longitude                Float?
  climateZone              String?
  nearestAirport           String?
  region                   String?
  type                     InstitutionType?
  classification           String?
  religiousAffiliation     String?
  setting                  CampusSetting?
  campusSizeAcres          Int?
  acceptanceRate           Float?
  acceptanceRateDraft      Float?                     // NEW: Draft field for approval workflow
  applicationFee           Int?
  commonAppAccepted        Boolean                    @default(false)
  applicationDeadline      DateTime?
  applicationDeadlineDraft DateTime?                  // NEW: Draft field
  earlyDecisionDeadline    DateTime?
  earlyDecisionDeadlineDraft DateTime?                // NEW: Draft field
  testPolicy               TestPolicy?
  minGpa                   Float?
  minGpaDraft              Float?                     // NEW: Draft field
  avgGpa                   Float?
  avgGpaDraft              Float?                     // NEW: Draft field
  satMath25                Int?
  satMath25Draft           Int?                       // NEW: Draft field
  satMath75                Int?
  satMath75Draft           Int?                       // NEW: Draft field
  satVerbal25              Int?
  satVerbal25Draft         Int?                       // NEW: Draft field
  satVerbal75              Int?
  satVerbal75Draft         Int?                       // NEW: Draft field
  actComposite25           Int?
  actComposite25Draft      Int?                       // NEW: Draft field
  actComposite75           Int?
  actComposite75Draft      Int?                       // NEW: Draft field
  avgSatScore              Int?
  avgSatScoreDraft         Int?                       // NEW: Draft field
  avgActScore              Int?
  avgActScoreDraft         Int?                       // NEW: Draft field
  internationalEngReqs     Json?
  tuitionInState           Int?
  tuitionInStateDraft      Int?                       // NEW: Draft field
  tuitionOutState          Int?
  tuitionOutStateDraft     Int?                       // NEW: Draft field
  tuitionInternational     Int?
  tuitionInternationalDraft Int?                      // NEW: Draft field
  roomAndBoard             Int?
  roomAndBoardDraft        Int?                       // NEW: Draft field
  booksAndSupplies         Int?
  booksAndSuppliesDraft    Int?                       // NEW: Draft field
  costOfLiving             Int?
  costOfLivingDraft        Int?                       // NEW: Draft field
  percentReceivingAid      Float?
  averageGrantAid          Int?
  averageNetPrice          Int?
  scholarshipsIntl         Boolean                    @default(false)
  needBlindAdmission       Boolean                    @default(false)
  studentPopulation        Int?
  studentPopulationDraft   Int?                       // NEW: Draft field
  undergraduatePopulation  Int?
  graduatePopulation       Int?
  studentFacultyRatio      Float?
  percentMale              Float?
  percentFemale            Float?
  percentInternational     Float?
  diversityScore           Float?
  graduationRate           Float?
  retentionRate            Float?
  employmentRate           Float?
  averageStartingSalary    Int?
  internshipSupport        Int?
  alumniNetwork            Int?
  visaDurationMonths       Int?
  academicCalendar         AcademicCalendar?
  sportsDivision           String?
  hasHousing               Boolean                    @default(true)
  studentLifeScore         Float?
  safetyRating             Float?
  partySceneRating         Float?
  popularMajors            String[]
  degreeLevels             String[]
  languages                String[]
  studentLifeTags          String[]
  rankings                 Json?
  createdAt                DateTime                   @default(now())
  updatedAt                DateTime                   @updatedAt
  claimedAt                DateTime?
  claimedById              String?
  ROIPercentage            Float?
  alumniEarnings10Years    Int?
  alumniEarnings5Years     Int?
  averageSalaryByMajor     Json?
  citationIndex            Int?
  fundedResearch           Int?
  geographicDiversityScore Float?
  industryPartnerships     String[]
  internshipPlacementRate  Float?
  partnerCompaniesCount    Int?
  researchOutputScore      Float?
  studentSatisfactionScore Float?
  timeToEmploymentMonths   Int?
  
  // NEW (P29): Full-Text Search Indexing Fields
  // searchVector stores concatenated, pre-processed text from all Soft Blocks for FTS
  // For full PostgreSQL FTS performance, this should be of type 'tsvector', which requires a raw migration
  searchVector             String?
  searchVectorUpdatedAt    DateTime?
  
  riskAssessments          ComparisonRiskAssessment[]
  microContent             MicroContent[]
  reviews                  Review[]
  savedBy                  SavedUniversity[]
  claimedBy                User?                      @relation("UniversityClaim", fields: [claimedById], references: [id])
  claims                   UniversityClaim[]
  metricHistory            UniversityMetricHistory[]
  groups                   UniversityGroup[]          @relation("GroupMembership")

  @@index([slug])
  @@index([country])
  @@index([name])
  @@index([tuitionOutState])
  @@index([avgSatScore])
}

model SavedUniversity {
  id           String            @id @default(uuid())
  userId       String
  universityId String
  status       ApplicationStatus @default(PLANNED)
  notes        String?
  createdAt    DateTime          @default(now())
  university   University        @relation(fields: [universityId], references: [id], onDelete: Cascade)
  user         User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, universityId])
}

model SavedArticle {
  id        String   @id @default(uuid())
  userId    String
  articleId String
  notes     String?
  createdAt DateTime @default(now())
  article   Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, articleId])
}

model UniversityClaim {
  id                    String           @id @default(uuid())
  userId                String
  universityId          String?
  status                ClaimStatus      @default(PENDING)
  claimType             ClaimType        @default(ACADEMIC_STAFF)
  institutionalEmail    String
  verificationDocuments String[]
  position              String?
  department            String?
  comments              String?
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  adminNotes            String?
  expiresAt             DateTime?
  requesterEmail        String           @default("")
  requesterName         String           @default("")
  reviewedAt            DateTime?
  reviewedById          String?
  universityGroupId     String?
  viewedAt              DateTime?
  auditLog              Json?               @default("[]")
  ClaimMessage          ClaimMessage[]
  documentApprovals     DocumentApproval[]
  reviewedBy            User?               @relation("ClaimReviewer", fields: [reviewedById], references: [id])
  universityGroup       UniversityGroup?    @relation(fields: [universityGroupId], references: [id], onDelete: Cascade)
  university            University?         @relation(fields: [universityId], references: [id], onDelete: Cascade)
  user                  User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([universityId])
  @@index([universityGroupId])
  @@index([status])
}

model DocumentApproval {
  id               String              @id @default(uuid())
  claimId          String
  documentUrl      String
  documentType     String              // "image" or "pdf"
  documentName     String
  status           DocumentStatus      @default(PENDING)
  adminNotes       String?
  reviewedAt       DateTime?
  reviewedById     String?
  canResubmit      Boolean             @default(true)
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  claim            UniversityClaim     @relation(fields: [claimId], references: [id], onDelete: Cascade)
  reviewedBy       User?               @relation("DocumentReviewer", fields: [reviewedById], references: [id])

  @@index([claimId])
  @@index([status])
}

model FinancialProfile {
  id                         String   @id @default(uuid())
  userId                     String   @unique
  maxBudget                  Int?
  householdIncome            Int?
  familySize                 Int?
  savings                    Int?
  investments                Int?
  expectedFamilyContribution Int?
  eligibleForPellGrant       Boolean  @default(false)
  eligibleForStateAid        Boolean  @default(false)
  createdAt                  DateTime @default(now())
  updatedAt                  DateTime @updatedAt
  needsFinancialAid          Boolean  @default(false)
  user                       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model AcademicProfile {
  id               String   @id @default(uuid())
  userId           String   @unique
  gpa              Float?
  gpaScale         Int?
  testScores       Json?
  highSchoolName   String?
  gradYear         Int?
  primaryMajor     String?
  secondaryMajor   String?
  extracurriculars String[]
  academicHonors   Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([gradYear])
  @@index([gpa])
  @@index([primaryMajor])
}

model Comparison {
  id              String                     @id @default(uuid())
  name            String
  userId          String
  universityIds   String[]
  createdAt       DateTime                   @default(now())
  description     String?
  user            User                       @relation(fields: [userId], references: [id], onDelete: Cascade)
  insights        ComparisonInsight[]
  riskAssessments ComparisonRiskAssessment[]
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  type      String
  title     String
  message   String
  link      String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
}

model Referral {
  id             String         @id @default(uuid())
  referrerId     String
  referredUserId String         @unique
  status         ReferralStatus @default(PENDING)
  rewardClaimed  Boolean        @default(false)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  rewardAmount   Int            @default(0)
  referredUser   User           @relation("Referred", fields: [referredUserId], references: [id], onDelete: Cascade)
  referrer       User           @relation("Referrer", fields: [referrerId], references: [id], onDelete: Cascade)

  @@index([referrerId])
  @@index([status])
}

model Category {
  id          String    @id @default(uuid())
  name        String
  slug        String    @unique
  description String?
  createdAt   DateTime  @default(now())
  articles    Article[]
}

model Tag {
  id        String    @id @default(uuid())
  name      String    @unique
  slug      String    @unique
  createdAt DateTime  @default(now())
  articles  Article[] @relation("ArticleToTag")
}

model Article {
  id              String              @id @default(uuid())
  slug            String              @unique
  title           String
  excerpt         String?
  content         String
  featuredImage   String?
  status          ArticleStatus       @default(DRAFT)
  publishedAt     DateTime?
  metaTitle       String?
  metaDescription String?
  authorId        String
  categoryId      String?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  viewCount       Int                 @default(0)
  canonicalUrl    String?
  focusKeyword    String?
  likeCount       Int                 @default(0)
  ogImage         String?
  rejectionReason String?
  reviewedAt      DateTime?
  reviewedById    String?
  shareCount      Int                 @default(0)
  rejectionCount  Int                 @default(0)
  scheduledForDeletion DateTime?
  author          User                @relation("ArticleAuthor", fields: [authorId], references: [id])
  category        Category?           @relation(fields: [categoryId], references: [id])
  reviewedBy      User?               @relation("ArticleReviewer", fields: [reviewedById], references: [id])
  analytics       ArticleAnalytics[]
  likes           ArticleLike[]
  savedByUsers    SavedArticle[]
  predictions     ArticlePrediction[]
  comments        Comment[]
  tags            Tag[]               @relation("ArticleToTag")

  @@index([slug])
  @@index([status])
  @@index([authorId])
}

model ArticleLike {
  id        String   @id @default(uuid())
  articleId String
  userId    String
  createdAt DateTime @default(now())
  article   Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([articleId, userId])
  @@index([articleId])
  @@index([userId])
}

model ArticleAnalytics {
  id        String   @id @default(uuid())
  articleId String
  date      DateTime @default(now())
  views     Int      @default(0)
  likes     Int      @default(0)
  comments  Int      @default(0)
  shares    Int      @default(0)
  article   Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@unique([articleId, date])
  @@index([articleId])
  @@index([date])
}

model Comment {
  id        String    @id @default(uuid())
  content   String
  articleId String
  userId    String
  parentId  String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  downvotes Int       @default(0)
  upvotes   Int       @default(0)
  article   Article   @relation(fields: [articleId], references: [id], onDelete: Cascade)
  parent    Comment?  @relation("CommentThread", fields: [parentId], references: [id])
  replies   Comment[] @relation("CommentThread")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Review {
  id             String       @id @default(uuid())
  rating         Float
  academicRating Float?
  campusRating   Float?
  socialRating   Float?
  careerRating   Float?
  title          String?
  content        String
  status         ReviewStatus @default(PENDING)
  universityId   String
  userId         String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  anonymous      Boolean      @default(false)
  helpfulCount   Int          @default(0)
  verified       Boolean      @default(false)
  university     University   @relation(fields: [universityId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, universityId])
  @@index([universityId])
  @@index([status])
}

model UniversityGroup {
  id           String            @id @default(uuid())
  name         String
  slug         String            @unique
  description  String?
  logoUrl      String?
  website      String?
  memberCount  Int               @default(0)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  claimedAt    DateTime?
  claimedById  String?
  
  // A. Identity & Overview
  groupType                  String?              // Public, Private, Semi-public
  city                       String?
  region                     String?
  yearFounded                Int?
  governanceStructure        String?
  numberOfCampuses           Int?
  totalStudentPopulation     Int?
  totalStaffCount            Int?
  
  // B. Academics & Programs Offered
  fieldsOfStudy              String[]             // Sciences, Business, Law, etc.
  levelCoverage              String[]             // Licence/Bachelor, Master, Doctorat
  signaturePrograms          String[]
  accreditations             String[]             // HCÃ‰RES, CTI, CEFDG, EPAS, EQUIS
  programQualityScore        Float?               // 0-100
  graduationRate             Float?               // 0-1 (percentage)
  
  // C. Admissions & Selectivity
  selectivityLevel           String?              // High, Medium, Low
  averageEntryRequirements   String?
  admissionProcedure         String?
  internationalAdmission     Boolean              @default(false)
  tuitionRangeMin            Int?
  tuitionRangeMax            Int?
  
  // D. Rankings & Reputation
  nationalRanking            Int?
  internationalRanking       Int?
  specialtyRankings          Json?                // { "Law": 5, "Engineering": 10 }
  employerReputationScore    Float?               // 0-100
  researchReputationScore    Float?               // 0-100
  
  // E. Research & Innovation
  researchCentersCount       Int?
  doctoralSchoolsCount       Int?
  annualPublications         Int?
  patentsFiled               Int?
  researchBudget             Float?
  industryPartnershipsCount  Int?
  
  // F. Student Life & Facilities
  campusInfrastructureRating Float?               // 0-5
  librariesCount             Int?
  studentAssociationsCount   Int?
  annualEventsCount          Int?
  sportsRanking              Int?
  housingAvailability        String?              // Excellent, Good, Limited
  diningFacilitiesCount      Int?
  
  // G. International Outlook
  internationalStudentsPct   Float?               // 0-1 (percentage)
  partnerUniversitiesCount   Int?
  exchangePrograms           String[]             // Erasmus, bilateral, etc.
  englishCoursesAvailable    Boolean              @default(false)
  doubleDegreeOpportunities  Boolean              @default(false)
  
  // H. Financial & Economic Metrics
  scholarshipOptions         String[]
  operationalBudget          Float?
  fundingSources             Json?                // { "state": 60, "private": 30, "research": 10 }
  
  // I. Outcomes & Employability
  employmentRate             Float?               // 0-1 (percentage)
  medianSalary               Int?                 // 6-12 months after graduation
  topEmployers               String[]
  
  // Metric Mode Configuration
  // Tracks which fields use static (admin-provided) vs dynamic (calculated) values
  // Format: { "totalStudentPopulation": "static", "graduationRate": "dynamic", ... }
  metricModes                Json?                @default("{}")
  
  // Cached calculated metrics (for performance)
  calculatedMetricsCache     Json?
  cacheUpdatedAt             DateTime?
  
  claims       UniversityClaim[]
  claimedBy    User?             @relation("UniversityGroupClaim", fields: [claimedById], references: [id])
  universities University[]      @relation("GroupMembership")
}

model MicroContent {
  id               String               @id @default(uuid())
  universityId     String
  blockType        String               @default("rich_text_block")
  title            String
  data             Json                 @default("{}")
  priority         Int                  @default(0)
  isActive         Boolean              @default(true)
  isHard           Boolean              @default(false) // NEW: Flag for mandatory/non-deletable UI blocks (e.g., Location, About)
  canonicalMapping String?              // NEW: The specific University column this block writes to (e.g., 'acceptanceRate')
  templateId       String?              // NEW: Link to a GlobalBlockTemplate for inherited content

  category         String?
  content          String?
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  
  university       University           @relation(fields: [universityId], references: [id])
  template         GlobalBlockTemplate? @relation(fields: [templateId], references: [id]) // NEW relation

  @@index([universityId])
  @@index([blockType])
  @@index([templateId])
}

model StaticPage {
  id              String   @id @default(uuid())
  slug            String   @unique
  title           String
  content         String
  metaTitle       String?
  metaDescription String?
  published       Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Badge {
  id          String      @id @default(uuid())
  slug        String      @unique
  name        String
  description String?
  iconUrl     String?
  category    String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  userBadges  UserBadge[]

  @@index([slug])
  @@index([category])
}

model UserBadge {
  id        String   @id @default(uuid())
  userId    String
  badgeId   String
  awardedAt DateTime @default(now())
  badge     Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@index([userId])
  @@index([badgeId])
}

model UniversityMetricHistory {
  id             String     @id @default(uuid())
  universityId   String
  year           Int
  ranking        Int?
  acceptanceRate Float?
  tuitionCost    Int?
  employmentRate Float?
  averageSalary  Int?
  studentCount   Int?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  university     University @relation(fields: [universityId], references: [id], onDelete: Cascade)

  @@unique([universityId, year])
  @@index([universityId])
  @@index([year])
}

model AnalysisWeights {
  id                  String   @id @default(uuid())
  userId              String   @unique
  ranking             Float    @default(0.25)
  cost                Float    @default(0.25)
  acceptance          Float    @default(0.15)
  employmentRate      Float    @default(0.15)
  studentSatisfaction Float    @default(0.10)
  research            Float    @default(0.10)
  targetSalary        Int?
  careerFocus         String?
  preferredLocation   String?
  internshipImportant Boolean  @default(false)
  researchImportant   Boolean  @default(false)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model ComparisonRiskAssessment {
  id               String     @id @default(uuid())
  comparisonId     String
  universityId     String
  riskFactors      Json
  overallRiskScore Float
  recommendations  String[]
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  comparison       Comparison @relation(fields: [comparisonId], references: [id], onDelete: Cascade)
  university       University @relation(fields: [universityId], references: [id], onDelete: Cascade)

  @@unique([comparisonId, universityId])
  @@index([comparisonId])
  @@index([universityId])
}

model ComparisonInsight {
  id           String     @id @default(uuid())
  comparisonId String
  insight      String
  insightType  String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  comparison   Comparison @relation(fields: [comparisonId], references: [id], onDelete: Cascade)

  @@index([comparisonId])
  @@index([insightType])
}

model ArticlePrediction {
  id        String   @id @default(uuid())
  articleId String
  inputHash String   @unique
  features  Json
  result    Json
  version   Int      @default(1)
  createdAt DateTime @default(now())
  article   Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@index([articleId])
  @@index([inputHash])
  @@index([createdAt])
}

model SystemBenchmark {
  id                 String   @id @default(uuid())
  category           String   @unique
  rpm                Float
  avgSearchVolume    Int
  avgCTR             Float
  seasonalMultiplier Float    @default(1.0)
  competitionLevel   Int      @default(5)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([category])
}

model Video {
  id           String   @id @default(uuid())
  title        String
  description  String?
  url          String
  publicId     String?
  type         String
  thumbnailUrl String?
  position     Int      @default(0)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([isActive, position])
  @@index([createdAt])
}

model ClaimMessage {
  id                 String            @id
  claimId            String
  senderId           String
  senderRole         String
  content            String
  type               CommunicationType @default(CHAT)
  requestedDocuments String[]
  attachments        String[]
  dataRequestSchema  Json?
  submittedData      Json?
  read               Boolean           @default(false)
  createdAt          DateTime          @default(now())
  UniversityClaim    UniversityClaim   @relation(fields: [claimId], references: [id], onDelete: Cascade)
  User               User              @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([claimId])
  @@index([senderId])
}

// NEW Model: Global Block Templates for reusable soft content
model GlobalBlockTemplate {
  id               String           @id @default(uuid())
  name             String
  blockType        String           // Type of block (checklist, faq, etc.)
  description      String?
  data             Json             @default("{}") // The reusable content data
  category         String?
  isSystem         Boolean          @default(false) // Flag for system-locked templates (like the standard checklist)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  contentInstances MicroContent[] // Blocks using this template

  @@index([blockType])
  @@index([isSystem])
}

enum UserRole {
  USER
  ADMIN
  PREMIUM
}

enum ApplicationStatus {
  PLANNED
  APPLIED
  ACCEPTED
  REJECTED
  WAITLISTED
}

enum ArticleStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
  PENDING
  REJECTED
  NEEDS_REVISION
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
}

enum InstitutionType {
  PUBLIC
  PRIVATE_NON_PROFIT
  PRIVATE_FOR_PROFIT
}

enum CampusSetting {
  URBAN
  SUBURBAN
  RURAL
}

enum AcademicCalendar {
  SEMESTER
  QUARTER
  TRIMESTER
}

enum TestPolicy {
  REQUIRED
  OPTIONAL
  BLIND
}

enum ClaimStatus {
  PENDING
  APPROVED
  REJECTED
  VERIFIED
  UNDER_REVIEW
  ACTION_REQUIRED
  PENDING_DOCUMENTS
  ARCHIVED
}

enum ClaimType {
  ACADEMIC_STAFF
  ALUMNI
  STUDENT
  ADMINISTRATIVE_STAFF
  DATA_UPDATE
}

enum DocumentStatus {
  PENDING
  APPROVED
  REJECTED
  REPLACED
}

enum CommunicationType {
  CHAT
  DOCUMENT_REQUEST
  INTERNAL_NOTE
}

enum ReferralStatus {
  PENDING
  COMPLETED
}

enum ProfileVisibility {
  PUBLIC
  PRIVATE
  FOLLOWERS_ONLY
}

// ==========================================
// ANALYTICS MODELS
// ==========================================

// Individual page view tracking
model PageView {
  id         String   @id @default(uuid())
  page       String   // 'article', 'university', 'group', 'home', 'search', 'compare', 'blog'
  entityId   String?  // article/university/group ID if applicable
  entitySlug String?  // for easier querying
  userId     String?  // null for anonymous visitors
  sessionId  String   // anonymous session tracking (UUID or fingerprint)
  referrer   String?  // where traffic came from
  userAgent  String?  // browser/device info
  country    String?
  city       String?
  device     String?  // 'mobile', 'tablet', 'desktop'
  browser    String?  // 'chrome', 'firefox', 'safari', etc.
  duration   Int?     // time spent on page in seconds (updated on page leave)
  createdAt  DateTime @default(now())

  @@index([page, entityId])
  @@index([page, entitySlug])
  @@index([createdAt])
  @@index([userId])
  @@index([sessionId])
}

// Daily aggregated analytics for performance
model DailyAnalytics {
  id             String   @id @default(uuid())
  date           DateTime @db.Date
  entityType     String   // 'article', 'university', 'group', 'site'
  entityId       String?  // null for site-wide metrics
  pageViews      Int      @default(0)
  uniqueVisitors Int      @default(0)
  avgDuration    Float?   // average time on page in seconds
  bounceRate     Float?   // percentage of single-page sessions
  newVisitors    Int      @default(0)
  returningVisitors Int   @default(0)
  mobileViews    Int      @default(0)
  desktopViews   Int      @default(0)
  tabletViews    Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([date, entityType, entityId])
  @@index([date])
  @@index([entityType, entityId])
  @@index([entityType])
}

// User engagement events (clicks, shares, downloads, etc.)
model EngagementEvent {
  id         String   @id @default(uuid())
  userId     String?  // null for anonymous
  sessionId  String
  eventType  String   // 'click', 'share', 'download', 'search', 'like', 'comment', 'save', 'compare', 'block_vote', 'block_toggle', 'block_cta_click', etc.
  entityType String?  // 'article', 'university', 'group'
  entityId   String?
  blockId    String?  // The ID of the MicroContent block
  blockType  String?  // The type of MicroContent block (e.g., 'quick_poll_survey', 'checklist')
  metadata   Json?    // additional context (e.g., search query, button clicked, option selected, item toggled)
  createdAt  DateTime @default(now())

  @@index([eventType])
  @@index([userId])
  @@index([entityType, entityId])
  @@index([blockId])
  @@index([createdAt])
}

// Search analytics
model SearchAnalytics {
  id          String   @id @default(uuid())
  query       String
  userId      String?
  sessionId   String
  resultsCount Int     @default(0)
  clickedResult String? // ID of the result clicked
  page        String   // 'university_search', 'blog_search', 'general'
  filters     Json?    // search filters applied
  createdAt   DateTime @default(now())

  @@index([query])
  @@index([createdAt])
  @@index([page])
}

// Traffic sources aggregation
model TrafficSource {
  id         String   @id @default(uuid())
  date       DateTime @db.Date
  source     String   // 'direct', 'organic', 'social', 'referral', 'email', 'paid'
  medium     String?  // more specific (e.g., 'google', 'facebook', 'twitter')
  campaign   String?  // UTM campaign if present
  visits     Int      @default(0)
  pageViews  Int      @default(0)
  bounceRate Float?
  avgDuration Float?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([date, source, medium, campaign])
  @@index([date])
  @@index([source])
}

// Geographic analytics
model GeoAnalytics {
  id          String   @id @default(uuid())
  date        DateTime @db.Date
  country     String
  city        String?
  visits      Int      @default(0)
  uniqueUsers Int      @default(0)
  pageViews   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([date, country, city])
  @@index([date])
  @@index([country])
}

// Article-specific detailed analytics (extends existing ArticleAnalytics)
model ArticleDetailedAnalytics {
  id               String   @id @default(uuid())
  articleId        String
  date             DateTime @db.Date
  impressions      Int      @default(0) // times shown in lists
  clicks           Int      @default(0) // clicks from lists
  readTime         Float?   // average read time in seconds
  scrollDepth      Float?   // average scroll depth percentage
  socialShares     Json?    // { facebook: 0, twitter: 0, linkedin: 0 }
  conversionRate   Float?   // percentage of visitors who engaged
  topReferrers     Json?    // top 5 referrer domains
  topCountries     Json?    // top 5 countries
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([articleId, date])
  @@index([articleId])
  @@index([date])
}

// University page analytics
model UniversityAnalytics {
  id               String   @id @default(uuid())
  universityId     String
  date             DateTime @db.Date
  pageViews        Int      @default(0)
  uniqueVisitors   Int      @default(0)
  saveCount        Int      @default(0)  // added to saved list
  compareCount     Int      @default(0)  // added to comparison
  reviewViews      Int      @default(0)
  websiteClicks    Int      @default(0)  // clicks to university website
  avgTimeOnPage    Float?
  topReferrers     Json?
  visitorTypes     Json?    // { student: 0, parent: 0, counselor: 0 }
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([universityId, date])
  @@index([universityId])
  @@index([date])
}

// Group page analytics
model GroupAnalytics {
  id               String   @id @default(uuid())
  groupId          String
  date             DateTime @db.Date
  pageViews        Int      @default(0)
  uniqueVisitors   Int      @default(0)
  universityClicks Int      @default(0)  // clicks to member universities
  websiteClicks    Int      @default(0)
  avgTimeOnPage    Float?
  topReferrers     Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([groupId, date])
  @@index([groupId])
  @@index([date])
}

// Author analytics summary (for article authors)
model AuthorAnalytics {
  id               String   @id @default(uuid())
  userId           String
  date             DateTime @db.Date
  totalViews       Int      @default(0)
  totalLikes       Int      @default(0)
  totalComments    Int      @default(0)
  totalShares      Int      @default(0)
  articlesCount    Int      @default(0)
  avgEngagementRate Float?
  topArticle       String?  // articleId of best performing
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}
