// server/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- Enums ---
enum UserRole {
  USER
  ADMIN
}

enum ApplicationStatus {
  PLANNED
  APPLIED
  ACCEPTED
  REJECTED
  WAITLISTED
}

enum ArticleStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
}

enum InstitutionType {
  PUBLIC
  PRIVATE_NON_PROFIT
  PRIVATE_FOR_PROFIT
}

enum CampusSetting {
  URBAN
  SUBURBAN
  RURAL
}

enum AcademicCalendar {
  SEMESTER
  QUARTER
  TRIMESTER
}

enum TestPolicy {
  REQUIRED
  TEST_OPTIONAL
  TEST_BLIND
}

// --- Core Models ---

model User {
  id        String  @id @default(uuid())
  clerkId   String  @unique // Links to Clerk Auth
  email     String  @unique
  firstName String?
  lastName  String?
  avatarUrl String?

  // --- Extended Academic Profile (Legacy Port) ---
  gpa            Float?
  satScore       Int?
  actScore       Int?
  maxBudget      Int? // Annual budget
  preferredMajor String?
  
  // New Legacy Fields
  dreamJobTitle          String?
  careerGoals            String[] // Legacy: text[]
  preferredLearningStyle String?
  personalityType        String?
  hobbies                String[]
  languagesSpoken        String[]
  
  role UserRole @default(USER)

  // Relations
  savedUniversities SavedUniversity[]
  comparisons       Comparison[]
  articles          Article[]
  reviews           Review[]
  comments          Comment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clerkId])
}

model University {
  id           String  @id @default(uuid())
  slug         String  @unique
  name         String
  shortName    String? // Legacy: short_name
  description  String? @db.Text
  logoUrl      String?
  heroImageUrl String?
  websiteUrl   String?
  established  Int?    // Legacy: established_year

  // --- Location & Contact ---
  address   String?
  city      String
  state     String?
  zipCode   String?
  country   String  @default("USA")
  latitude  Float?
  longitude Float?
  
  // Legacy Location Fields
  climateZone         String?
  nearestAirport      String?
  region              String? // E.g. "Northeast"

  // --- Classification ---
  type                 InstitutionType? // Legacy: institution_type
  classification       String? // e.g., "Research University"
  religiousAffiliation String?
  setting              CampusSetting?   // Legacy: campus_setting
  campusSizeAcres      Int?

  // --- Admissions Stats ---
  acceptanceRate        Float? // 0.0 to 1.0
  applicationFee        Int?
  commonAppAccepted     Boolean   @default(false)
  applicationDeadline   DateTime?
  earlyDecisionDeadline DateTime?
  
  // Legacy Admissions Fields
  testPolicy            TestPolicy? // Legacy: standardized_test_policy
  minGpa                Float?
  avgGpa                Float?
  satMath25             Int?
  satMath75             Int?
  satVerbal25           Int?
  satVerbal75           Int?
  actComposite25        Int?
  actComposite75        Int?
  avgSatScore           Int?
  avgActScore           Int?
  internationalEngReqs  Json?     // Legacy: international_english_reqs (toefl/ielts)

  // --- Costs & Financials ---
  tuitionInState        Int?
  tuitionOutState       Int?
  tuitionInternational  Int?      // Legacy: tuition_international
  roomAndBoard          Int?
  booksAndSupplies      Int?
  costOfLiving          Int?      // Legacy: cost_of_living_est
  
  // --- Financial Aid ---
  percentReceivingAid   Float?    // 0.0 to 1.0
  averageGrantAid       Int?
  averageNetPrice       Int?
  scholarshipsIntl      Boolean   @default(false) // Legacy: scholarships_international
  needBlindAdmission    Boolean   @default(false) // Legacy: need_blind_admission

  // --- Student Body ---
  studentPopulation       Int?
  undergraduatePopulation Int?
  graduatePopulation      Int?
  studentFacultyRatio     Float?
  percentMale             Float?
  percentFemale           Float?
  percentInternational    Float?    // Legacy: percentage_international
  diversityScore          Float?    // 0.0 to 1.0

  // --- Outcomes ---
  graduationRate        Float?
  retentionRate         Float?
  employmentRate        Float?    // Legacy: employment_rate_6mo
  averageStartingSalary Int?
  
  // Legacy Future/Outcome Fields
  internshipSupport     Int?      // 1-5 scale
  alumniNetwork         Int?      // 1-5 scale
  visaDurationMonths    Int?      // Legacy: post_study_work_visa_months

  // --- Campus Life & Academics ---
  academicCalendar      AcademicCalendar? // Legacy: academic_calendar
  sportsDivision        String?
  hasHousing            Boolean @default(true)
  studentLifeScore      Float?    // 0.0 to 5.0
  safetyRating          Float?    // 0.0 to 5.0
  partySceneRating      Float?    // 0.0 to 5.0
  
  // Arrays & Metadata
  popularMajors         String[]
  degreeLevels          String[]  // Legacy: degree_levels_offered
  languages             String[]  // Legacy: languages_of_instruction
  studentLifeTags       String[]  // Legacy: student_life_tags
  rankings              Json?     // { "usNews": 5, "forbes": 12 }

  // --- Relations ---
  savedBy SavedUniversity[]
  reviews Review[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([country])
  @@index([name])
  @@index([tuitionOutState])
  @@index([avgSatScore])
}

model SavedUniversity {
  id           String     @id @default(uuid())
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId       String
  university   University @relation(fields: [universityId], references: [id], onDelete: Cascade)
  universityId String

  status ApplicationStatus @default(PLANNED)
  notes  String? @db.Text

  createdAt DateTime @default(now())

  @@unique([userId, universityId])
}

model Comparison {
  id     String @id @default(uuid())
  name   String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  universityIds String[]

  createdAt DateTime @default(now())
}

// --- Content Management System (Restored) ---

model Category {
  id          String    @id @default(uuid())
  name        String
  slug        String    @unique
  description String?
  articles    Article[]

  createdAt DateTime @default(now())
}

model Tag {
  id        String    @id @default(uuid())
  name      String    @unique
  slug      String    @unique
  articles  Article[]

  createdAt DateTime @default(now())
}

model Article {
  id            String  @id @default(uuid())
  slug          String  @unique
  title         String
  excerpt       String? @db.Text
  content       String  @db.Text
  featuredImage String?
  status        ArticleStatus @default(DRAFT)
  publishedAt   DateTime?
  
  // SEO
  metaTitle       String?
  metaDescription String?

  // Relations
  authorId String
  author   User   @relation(fields: [authorId], references: [id])

  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id])
  
  tags      Tag[]

  comments Comment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([status])
}

model Comment {
  id      String @id @default(uuid())
  content String @db.Text

  articleId String
  article   Article @relation(fields: [articleId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  parentId String?
  parent   Comment?  @relation("CommentThread", fields: [parentId], references: [id])
  replies  Comment[] @relation("CommentThread")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Review {
  id     String @id @default(uuid())
  rating Float // Overall rating 1-5

  // Detailed Breakdown
  academicRating Float?
  campusRating   Float?
  socialRating   Float?
  careerRating   Float?

  title   String?
  content String       @db.Text
  status  ReviewStatus @default(PENDING)

  universityId String
  university   University @relation(fields: [universityId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, universityId])
  @@index([universityId])
  @@index([status])
}
