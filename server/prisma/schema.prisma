// server/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- Enums ---
enum UserRole {
  USER
  PREMIUM
  ADMIN
}

enum ApplicationStatus {
  PLANNED
  APPLIED
  ACCEPTED
  REJECTED
  WAITLISTED
}

enum ArticleStatus {
  DRAFT
  PENDING
  REJECTED
  PUBLISHED
  ARCHIVED
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
}

enum InstitutionType {
  PUBLIC
  PRIVATE_NON_PROFIT
  PRIVATE_FOR_PROFIT
}

enum CampusSetting {
  URBAN
  SUBURBAN
  RURAL
}

enum AcademicCalendar {
  SEMESTER
  QUARTER
  TRIMESTER
}

enum TestPolicy {
  REQUIRED
  OPTIONAL
  BLIND
}

enum ClaimStatus {
  PENDING
  APPROVED
  REJECTED
  VERIFIED
}

enum ReferralStatus {
  PENDING
  COMPLETED
}

enum ProfileVisibility {
  PUBLIC
  PRIVATE
  FOLLOWERS_ONLY
}

// --- Core Models ---

model User {
  id        String  @id @default(uuid())
  clerkId   String  @unique // Links to Clerk Auth
  email     String  @unique
  firstName String?
  lastName  String?
  avatarUrl String?
  username  String? @unique // For public profile URL

  // --- Profile Privacy & Visibility ---
  profileVisibility ProfileVisibility @default(PRIVATE)
  profileSettings   Json? // Granular field visibility: { showEmail, showBadges, showAcademics, showSavedCount, etc }

  // --- Onboarding System ---
  onboarded         Boolean @default(false)
  onboardingSkipped Boolean @default(false)
  accountType       String? // 'INDIVIDUAL' or 'ORGANIZATION'
  personaRole       String? // For individuals: e.g., 'STUDENT', 'PROFESSIONAL'
  focusArea         String? // For individuals: e.g., 'COMPUTER_SCIENCE', 'BUSINESS'
  primaryGoal       String? // For individuals: e.g., 'FIND_FINANCIAL_AID', 'CAREER_MATCHING'
  organizationName  String? // For organizations: Name of the organization
  onboardingAnswers Json?   // Flexible JSONB store for raw questionnaire data

  // --- Extended Academic Profile (Legacy Port) ---
  gpa            Float?
  satScore       Int?
  actScore       Int?
  preferredMajor String?
  
  // New Legacy Fields
  dreamJobTitle          String?
  careerGoals            String[] // Legacy: text[]
  preferredLearningStyle String?
  personalityType        String?
  hobbies                String[]
  languagesSpoken        String[]
  
  // Referral System
  referralCode String? @unique
  referredBy   String?
  referrer     User?   @relation("UserReferrals", fields: [referredBy], references: [id])
  referrals    User[]  @relation("UserReferrals")
  
  role UserRole @default(USER)

  // Relations
  academicProfile   AcademicProfile?
  financialProfile  FinancialProfile?
  analysisWeights   AnalysisWeights?
  savedUniversities SavedUniversity[]
  comparisons       Comparison[]
  articles          Article[] @relation("ArticleAuthor")
  reviewedArticles  Article[] @relation("ArticleReviewer")
  articleLikes      ArticleLike[]
  reviews           Review[]
  comments          Comment[]
  notifications     Notification[]
  universityClaims  UniversityClaim[]
  reviewedClaims    UniversityClaim[] @relation("ClaimReviewer")
  claimedUniversities University[] @relation("UniversityClaim")
  claimedUniversityGroups UniversityGroup[] @relation("UniversityGroupClaim")
  referralsGiven    Referral[] @relation("Referrer")
  referralsReceived Referral[] @relation("Referred")
  badges            UserBadge[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clerkId])
  @@index([username])
}

model University {
  id           String  @id @default(uuid())
  slug         String  @unique
  name         String
  shortName    String? // Legacy: short_name
  description  String? @db.Text
  logoUrl      String?
  heroImageUrl String?
  websiteUrl   String?
  established  Int?    // Legacy: established_year

  // --- Location & Contact ---
  address   String?
  city      String
  state     String?
  zipCode   String?
  country   String  @default("USA")
  latitude  Float?
  longitude Float?
  
  // Legacy Location Fields
  climateZone         String?
  nearestAirport      String?
  region              String? // E.g. "Northeast"

  // --- Classification ---
  type                 InstitutionType? // Legacy: institution_type
  classification       String? // e.g., "Research University"
  religiousAffiliation String?
  setting              CampusSetting?   // Legacy: campus_setting
  campusSizeAcres      Int?

  // --- Admissions Stats ---
  acceptanceRate        Float? // 0.0 to 1.0
  applicationFee        Int?
  commonAppAccepted     Boolean   @default(false)
  applicationDeadline   DateTime?
  earlyDecisionDeadline DateTime?
  
  // Legacy Admissions Fields
  testPolicy            TestPolicy? // Legacy: standardized_test_policy
  minGpa                Float?
  avgGpa                Float?
  satMath25             Int?
  satMath75             Int?
  satVerbal25           Int?
  satVerbal75           Int?
  actComposite25        Int?
  actComposite75        Int?
  avgSatScore           Int?
  avgActScore           Int?
  internationalEngReqs  Json?     // Legacy: international_english_reqs (toefl/ielts)

  // --- Costs & Financials ---
  tuitionInState        Int?
  tuitionOutState       Int?
  tuitionInternational  Int?      // Legacy: tuition_international
  roomAndBoard          Int?
  booksAndSupplies      Int?
  costOfLiving          Int?      // Legacy: cost_of_living_est
  
  // --- Financial Aid ---
  percentReceivingAid   Float?    // 0.0 to 1.0
  averageGrantAid       Int?
  averageNetPrice       Int?
  scholarshipsIntl      Boolean   @default(false) // Legacy: scholarships_international
  needBlindAdmission    Boolean   @default(false) // Legacy: need_blind_admission

  // --- Student Body ---
  studentPopulation       Int?
  undergraduatePopulation Int?
  graduatePopulation      Int?
  studentFacultyRatio     Float?
  percentMale             Float?
  percentFemale           Float?
  percentInternational    Float?    // Legacy: percentage_international
  diversityScore          Float?    // 0.0 to 1.0

  // --- Outcomes & Success Metrics ---
  graduationRate        Float?
  retentionRate         Float?
  employmentRate        Float?    // Legacy: employment_rate_6mo (6-month employment rate)
  averageStartingSalary Int?
  
  // Advanced Success Metrics
  timeToEmploymentMonths Int?     // Average months to get first job
  averageSalaryByMajor   Json?    // { "CS": 120000, "Business": 85000 }
  ROIPercentage          Float?   // Return on investment percentage
  alumniEarnings5Years   Int?     // Average salary 5 years after graduation
  alumniEarnings10Years  Int?     // Average salary 10 years after graduation
  
  // Legacy Future/Outcome Fields
  internshipSupport     Int?      // 1-5 scale
  alumniNetwork         Int?      // 1-5 scale
  visaDurationMonths    Int?      // Legacy: post_study_work_visa_months
  
  // Research & Academic Excellence
  researchOutputScore    Float?   // 0-100 scale based on publications/citations
  citationIndex          Int?     // H-index for research output
  fundedResearch         Int?     // Annual funded research in millions
  
  // Industry Partnerships & Opportunities
  partnerCompaniesCount  Int?     // Number of industry partners
  industryPartnerships   String[] // List of major partner companies
  
  // Additional Metrics
  studentSatisfactionScore Float?  // 0-5 scale (from surveys)
  geographicDiversityScore Float?  // 0-1 scale for geographic distribution
  internshipPlacementRate  Float?  // 0-1 scale (percentage of students with internships)

  // --- Campus Life & Academics ---
  academicCalendar      AcademicCalendar? // Legacy: academic_calendar
  sportsDivision        String?
  hasHousing            Boolean @default(true)
  studentLifeScore      Float?    // 0.0 to 5.0
  safetyRating          Float?    // 0.0 to 5.0
  partySceneRating      Float?    // 0.0 to 5.0
  
  // Arrays & Metadata
  popularMajors         String[]
  degreeLevels          String[]  // Legacy: degree_levels_offered
  languages             String[]  // Legacy: languages_of_instruction
  studentLifeTags       String[]  // Legacy: student_life_tags
  rankings              Json?     // { "usNews": 5, "forbes": 12 }

  // --- Relations ---
  groups      UniversityGroup[] @relation("GroupMembership") // M:N relation
  microContent MicroContent[] // 1:N relation
  savedBy SavedUniversity[]
  reviews Review[]
  claims UniversityClaim[]
  metricHistory UniversityMetricHistory[] // Historical metrics for trends
  riskAssessments ComparisonRiskAssessment[] // Risk assessment snapshots
  
  // Claim ownership
  claimedBy User? @relation("UniversityClaim", fields: [claimedById], references: [id])
  claimedById String?
  claimedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([country])
  @@index([name])
  @@index([tuitionOutState])
  @@index([avgSatScore])
}

model SavedUniversity {
  id           String     @id @default(uuid())
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId       String
  university   University @relation(fields: [universityId], references: [id], onDelete: Cascade)
  universityId String

  status ApplicationStatus @default(PLANNED)
  notes  String? @db.Text

  createdAt DateTime @default(now())

  @@unique([userId, universityId])
}

model UniversityClaim {
  id                    String      @id @default(uuid())
  user                  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId                String
  university            University? @relation(fields: [universityId], references: [id], onDelete: Cascade)
  universityId          String?
  universityGroup       UniversityGroup? @relation(fields: [universityGroupId], references: [id], onDelete: Cascade)
  universityGroupId     String?
  status                ClaimStatus @default(PENDING)
  requesterName         String      @default("")
  requesterEmail        String      @default("")
  institutionalEmail    String
  verificationDocuments String[]    // URLs to verification documents
  position              String?
  department            String?
  comments              String?     @db.Text
  
  reviewedBy            User?       @relation("ClaimReviewer", fields: [reviewedById], references: [id])
  reviewedById          String?
  reviewedAt            DateTime?
  adminNotes            String?     @db.Text
  expiresAt             DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([universityId])
  @@index([universityGroupId])
  @@index([status])
}

model FinancialProfile {
  id String @id @default(uuid())
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @unique // 1:1 relation to User

  // Core Financials
  maxBudget Int?        // Annual budget
  householdIncome Int?
  familySize Int?

  // Extended Financials (from legacy schema)
  savings Int?
  investments Int?
  expectedFamilyContribution Int?
  eligibleForPellGrant Boolean @default(false)
  eligibleForStateAid Boolean @default(false)
  needsFinancialAid Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AcademicProfile {
  id     String @id @default(uuid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @unique // 1:1 relation to User

  // --- Core Academic Metrics ---
  gpa              Float?  // Current GPA
  gpaScale         Int?    // GPA scale (e.g., 4, 5, 10, 100)
  
  // --- Standardized Test Scores (Flexible JSON Storage) ---
  // Structure: { "SAT": { "total": 1450, "math": 750, "verbal": 700, "date": "2024-05" }, 
  //              "ACT": { "composite": 32, "english": 34, "math": 30, "reading": 33, "science": 31 },
  //              "AP": [{ "subject": "Calculus BC", "score": 5, "year": 2023 }],
  //              "IB": { "predicted": 42, "subjects": [...] } }
  testScores       Json?

  // --- High School Information ---
  highSchoolName   String? // Name of current/previous high school
  gradYear         Int?    // Expected or actual graduation year

  // --- Intended Majors ---
  primaryMajor     String? // Primary field of study interest
  secondaryMajor   String? // Secondary/alternate field of study

  // --- Extracurricular Activities ---
  // Array of activity descriptions (e.g., ["Student Council President", "Varsity Soccer Captain", "Debate Team"])
  extracurriculars String[]

  // --- Academic Honors & Awards ---
  // Structure: [{ "name": "National Merit Scholar", "year": 2024, "level": "National" },
  //             { "name": "Science Olympiad Gold Medal", "year": 2023, "level": "State" }]
  academicHonors   Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([gradYear])
  @@index([gpa])
  @@index([primaryMajor])
}

model Comparison {
  id          String   @id @default(uuid())
  name        String
  description String?
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String

  universityIds String[]
  
  // Relations to analysis data
  riskAssessments ComparisonRiskAssessment[]
  insights        ComparisonInsight[]

  createdAt DateTime @default(now())
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type      String   // E.g., "SYSTEM", "REVIEW_APPROVED", "COMMENT_REPLY"
  title     String
  message   String   @db.Text
  link      String?  // Internal link to redirect to (e.g., "/blog/article-1")
  
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([isRead])
}

model Referral {
  id             String         @id @default(uuid())
  referrer       User           @relation("Referrer", fields: [referrerId], references: [id], onDelete: Cascade)
  referrerId     String
  referredUser   User           @relation("Referred", fields: [referredUserId], references: [id], onDelete: Cascade)
  referredUserId String         @unique
  status         ReferralStatus @default(PENDING)
  rewardClaimed  Boolean        @default(false)
  rewardAmount   Int            @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([referrerId])
  @@index([status])
}

// --- Content Management System (Restored) ---

model Category {
  id          String    @id @default(uuid())
  name        String
  slug        String    @unique
  description String?
  articles    Article[]

  createdAt DateTime @default(now())
}

model Tag {
  id        String    @id @default(uuid())
  name      String    @unique
  slug      String    @unique
  articles  Article[]

  createdAt DateTime @default(now())
}

model Article {
  id            String  @id @default(uuid())
  slug          String  @unique
  title         String
  excerpt       String? @db.Text
  content       String  @db.Text
  featuredImage String?
  status        ArticleStatus @default(DRAFT)
  publishedAt   DateTime?
  
  // Analytics
  viewCount     Int @default(0)
  likeCount     Int @default(0)
  shareCount    Int @default(0)
  
  // SEO
  metaTitle       String?
  metaDescription String?
  focusKeyword    String?
  canonicalUrl    String?
  ogImage         String?

  // Review & Moderation
  rejectionReason String? @db.Text
  reviewedAt      DateTime?
  reviewedById    String?
  reviewedBy      User?    @relation("ArticleReviewer", fields: [reviewedById], references: [id])

  // Relations
  authorId String
  author   User   @relation("ArticleAuthor", fields: [authorId], references: [id])

  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id])
  
  tags      Tag[]
  comments Comment[]
  likes    ArticleLike[]
  analytics ArticleAnalytics[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([status])
  @@index([authorId])
}

model ArticleLike {
  id        String   @id @default(uuid())
  articleId String
  article   Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([articleId, userId])
  @@index([articleId])
  @@index([userId])
}

model ArticleAnalytics {
  id         String   @id @default(uuid())
  articleId  String
  article    Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  date       DateTime @default(now())
  views      Int      @default(0)
  likes      Int      @default(0)
  comments   Int      @default(0)
  shares     Int      @default(0)
  
  @@unique([articleId, date])
  @@index([articleId])
  @@index([date])
}

model Comment {
  id      String @id @default(uuid())
  content String @db.Text

  articleId String
  article   Article @relation(fields: [articleId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  parentId String?
  parent   Comment?  @relation("CommentThread", fields: [parentId], references: [id])
  replies  Comment[] @relation("CommentThread")

  // Engagement Fields
  upvotes   Int @default(0)
  downvotes Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Review {
  id     String @id @default(uuid())
  rating Float // Overall rating 1-5

  // Detailed Breakdown
  academicRating Float?
  campusRating   Float?
  socialRating   Float?
  careerRating   Float?

  title   String?
  content String       @db.Text
  status  ReviewStatus @default(PENDING)

  // Engagement Fields
  helpfulCount Int     @default(0)
  verified     Boolean @default(false)
  anonymous    Boolean @default(false)

  universityId String
  university   University @relation(fields: [universityId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, universityId])
  @@index([universityId])
  @@index([status])
}

model UniversityGroup {
  id          String     @id @default(uuid())
  name        String
  slug        String     @unique
  description String?    @db.Text
  logoUrl     String?
  website     String?
  memberCount Int        @default(0)

  universities University[] @relation("GroupMembership") // M:N relation
  claims       UniversityClaim[]
  
  // Claim ownership
  claimedBy User? @relation("UniversityGroupClaim", fields: [claimedById], references: [id])
  claimedById String?
  claimedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model MicroContent {
  id          String     @id @default(uuid())
  university  University @relation(fields: [universityId], references: [id])
  universityId String
  
  category    String     // e.g., "application_tips"
  title       String
  content     String     @db.Text
  priority    Int        @default(0)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([universityId])
}

model StaticPage {
  id               String    @id @default(uuid())
  slug             String    @unique
  title            String
  content          String    @db.Text
  
  metaTitle        String?
  metaDescription  String?   @db.Text

  published        Boolean   @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// --- Gamification System ---

model Badge {
  id          String     @id @default(uuid())
  slug        String     @unique
  name        String
  description String?    @db.Text
  iconUrl     String?
  category    String?

  userBadges  UserBadge[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([category])
}

model UserBadge {
  id        String   @id @default(uuid())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  badge     Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  badgeId   String
  awardedAt DateTime @default(now())

  @@unique([userId, badgeId])
  @@index([userId])
  @@index([badgeId])
}

// --- Analysis & Comparison System ---

// Historical metrics for trend analysis
model UniversityMetricHistory {
  id              String   @id @default(uuid())
  university      University @relation(fields: [universityId], references: [id], onDelete: Cascade)
  universityId    String
  
  // Historical snapshots
  year            Int
  ranking         Int?
  acceptanceRate  Float?
  tuitionCost     Int?
  employmentRate  Float?
  averageSalary   Int?
  studentCount    Int?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([universityId, year])
  @@index([universityId])
  @@index([year])
}

// User's custom analysis weights
model AnalysisWeights {
  id              String   @id @default(uuid())
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId          String
  
  // Weight configuration (0-1 scale, should sum close to 1.0)
  ranking         Float    @default(0.25)
  cost            Float    @default(0.25)
  acceptance      Float    @default(0.15)
  employmentRate  Float    @default(0.15)
  studentSatisfaction Float @default(0.10)
  research        Float    @default(0.10)
  
  // User profile preferences for matching
  targetSalary    Int?
  careerFocus     String?  // e.g., "Tech", "Finance", "Medicine"
  preferredLocation String?
  internshipImportant Boolean @default(false)
  researchImportant Boolean @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([userId])
  @@index([userId])
}

// Risk assessment snapshot for comparisons
model ComparisonRiskAssessment {
  id              String   @id @default(uuid())
  comparison      Comparison @relation(fields: [comparisonId], references: [id], onDelete: Cascade)
  comparisonId    String
  university      University @relation(fields: [universityId], references: [id], onDelete: Cascade)
  universityId    String
  
  // Risk factors
  riskFactors     Json     // Array of { factor: string, severity: "low"|"medium"|"high", description: string }
  overallRiskScore Float   // 0-100 (higher = more risky)
  recommendations String[] // Array of recommendations
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([comparisonId, universityId])
  @@index([comparisonId])
  @@index([universityId])
}

// Comparative insights (natural language analysis)
model ComparisonInsight {
  id              String   @id @default(uuid())
  comparison      Comparison @relation(fields: [comparisonId], references: [id], onDelete: Cascade)
  comparisonId    String
  
  insight         String   @db.Text // Natural language analysis
  insightType     String   // e.g., "cost_benefit", "career_outcome", "acceptance_difficulty"
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([comparisonId])
  @@index([insightType])
}

